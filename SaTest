function Get-UniqueContainerName {
    param ()

    $containerName = "testcontainer" + [System.Guid]::NewGuid().ToString("N")
    return $containerName
}

function Generate-TestFile {
    param (
        [string]$FilePath,
        [int]$FileSizeInKB
    )

    $bytes = New-Object byte[] ($FileSizeInKB * 1024)
    (Get-Random -InputObject (0..255) -Count $bytes.Length) | ForEach-Object { $bytes[$_] = $_ }
    $content = [System.Text.Encoding]::UTF8.GetString($bytes)

    try {
        $content | Out-File -FilePath $FilePath -Encoding UTF8
        Write-Host "Generated test file: $FilePath"
    }
    catch {
        Write-Host "Error occurred while generating the file: $_"
    }
}

function Send-FileToAzureStorageContainerWithManagedIdentity {
    param (
        [string]$StorageAccountName,
        [string]$ResourceGroupName,
        [string]$FileLocalPath
    )

    $testFileSizeInKB = 1024  # 1 MB (you can adjust the size as needed)
    $containerName = Get-UniqueContainerName

    # Create a new container using REST API
    $containerUrl = "https://$StorageAccountName.blob.core.windows.net/$containerName"
    $containerHeaders = @{
        "x-ms-version" = "2020-06-12"
        "Authorization" = $env:MSI_SECRET
    }
    Invoke-RestMethod -Uri $containerUrl -Headers $containerHeaders -Method Put

    # Generate the test file
    Generate-TestFile -FilePath $FileLocalPath -FileSizeInKB $testFileSizeInKB

    # Upload the file to the container using REST API
    $fileUrl = "$containerUrl/$(Split-Path $FileLocalPath -Leaf)"
    $fileHeaders = @{
        "x-ms-version" = "2020-06-12"
        "x-ms-blob-type" = "BlockBlob"
        "Authorization" = $env:MSI_SECRET
    }
    Invoke-RestMethod -Uri $fileUrl -Headers $fileHeaders -Method Put -InFile $FileLocalPath

    Write-Host "File '$FileLocalPath' sent to container '$containerName' in Storage Account '$StorageAccountName'."
}

# Parameters
$StorageAccountName = "YOUR_STORAGE_ACCOUNT_NAME"
$ResourceGroupName = "YOUR_RESOURCE_GROUP_NAME"
$FileLocalPath = "LOCAL_FILE_PATH.txt"

Send-FileToAzureStorageContainerWithManagedIdentity -StorageAccountName $StorageAccountName -ResourceGroupName $ResourceGroupName -FileLocalPath $FileLocalPath
